<!doctype html>
<html lang="en">
  <head>
    <link rel='stylesheet' href='http://ol3js.org/en/master/css/ol.css'>
    <title>OpenLayers 3 example</title>
    <script src='http://ol3js.org/en/master/build/ol.js'></script>
    <script src='http://code.jquery.com/jquery-1.11.1.js'></script>
    <style>
      html{height:100%}
      body{height:100%}
      #map{
        width:100%;
        height:98%;
      }
      .popup{
        background:white;
        width:250px;
        height:200px;
        border-radius:5px;
      }
    </style>
  </head>
  <body onload="init()">
    <div id="map"></div>
    <button style='position:absolute; left: 10px; top:30%;' onclick='removeTopLayer()'>Remove Top Layer</button>
     <button style='position:absolute; left: 10px; top:35%;' onclick='swapTopLayer()'>Swap Top Layers</button>
     <button class='draw-point' onclick='startDraw("Point")' style='position: absolute; top:40%;'>Draw Points</button>
      <button class='draw-line' onclick='startDraw("LineString")' style='position: absolute; top:45%;'>Draw Lines</button>
      <button class='draw-polygon' onclick='startDraw("Polygon")' style='position: absolute; top:50%;'>Draw Polygon</button>
    
    <script type="text/javascript">
      var map;
      //global variable
      var drawLayer;

      function init(){
          map = new ol.Map({
              target:'map',
              renderer:'canvas',
              view: new ol.View({
              projection: 'EPSG:900913',
              center:[-8015003.33712,4160979.44405],
              zoom:5
            })
          });

          var newLayer = new ol.layer.Tile({
            source: new ol.source.OSM()
          });
          map.addLayer(newLayer);

          var vectorLayer = new ol.layer.Tile({
            source: new ol.source.TileWMS({
              preload: Infinity,
              url: 'http://felek.cns.umass.edu:8080/geoserver/wms',
              serverType:'geoserver',
              params:{
                'LAYERS':"Streams:Developed", 'TILED':true
              }
            })
          });
          //vectorLayer.setOpacity(.3);
          vectorLayer.setVisible(false);
          map.addLayer(vectorLayer);

          var vectorLayer_2 = new ol.layer.Tile({
            source: new ol.source.TileWMS({
              preload: Infinity,
              url: 'http://felek.cns.umass.edu:8080/geoserver/wms',
              serverType:'geoserver',
              params:{
                'LAYERS':"Streams:Deposition_of_Nitrogen", 'TILED':true
              }
            })
          });
          vectorLayer_2.setVisible(false);
          map.addLayer(vectorLayer_2);

          //Define a style cache so we may store many styles into one variable.
          var styleCache = {};

          //Create a new layer using the ol.source.GeoJSON class.
          var geoLayer = new ol.layer.Vector({
              //Define the source, feed it our projection and the url to our file.
              source : new ol.source.GeoJSON({
              projection : 'EPSG:900913',
              url : './myGeoJson.geojson'
            }),
            //Define the style, using a hashtable and hash function for our style cache and set each individual object accordingly.
            style : function(feature, resolution) {
              var text = resolution < 5000 ? feature.get('name') : '';
              if (!styleCache[text]) {
                styleCache[text] = [new ol.style.Style({
                  // Inside of a closed polygon
                  fill : new ol.style.Fill({
                    color : 'rgba(255, 255, 255, 0.1)'
                  }),
                  // Perimeter of polygon
                  stroke : new ol.style.Stroke({
                    color : '#319FD3',
                    width : 1
                  }),
                  //Paramenters of any text used in the geoJson
                  text : new ol.style.Text({
                    font : '12px Calibri,sans-serif',
                    text : text,
                    fill : new ol.style.Fill({
                      color : '#000'
                    }),
                    stroke : new ol.style.Stroke({
                      color : '#fff',
                      width : 3
                    })
                  }),
                  zIndex : 999
                })];
              }
              //Return the style cache. Also set the zIndex to a higher number than any of the other laters.
              return styleCache[text];
            }
          });
          map.addLayer(geoLayer);
          myExtentButton = new ol.control.ZoomToExtent({
            extent: geoLayer.getSource().getExtent()
          });
          map.addControl(myExtentButton);

          map.on('singleclick', function(evt){
              var coord = evt.coordinate;
              
              //var transformed_coordinate = ol.proj.transform(coord, "EPSG:900913", "EPSG:4326");
              //console.log(transformed_coordinate);

              //spawnPopup(coord);

              // var viewProjection = map.getView().getProjection();
              // var viewResolution = map.getView().getResolution();
              // var url = vectorLayer.getSource().getGetFeatureInfoUrl(coord, viewResolution, viewProjection, {
              //   'INFO_FORMAT' : 'application/json'
              // });
              // if (url) {
              //   console.log(url)
              //     $.getJSON(url, function(d) {
              //         console.log(d);
              //   })
              // } else {
              //     console.log("Uh Oh, something went wrong.");
              // }


          })

          function spawnPopup(coord){
              var popup = $("<div class='popup'></div>");
              
              var overlay = new ol.Overlay({
                  element:popup
              });
              
              map.addOverlay(overlay);
              overlay.setPosition(coord);
          }



          //Inside init() function
          drawLayer = new ol.layer.Vector({
              source : new ol.source.Vector(),
            style : new ol.style.Style({
              fill : new ol.style.Fill({
                color : 'rgba(255, 255, 255, 0.2)'
              }),
              stroke : new ol.style.Stroke({
                color : '#ffcc33',
                width : 2
              }),
              image : new ol.style.Circle({
                radius : 7,
                fill : new ol.style.Fill({
                  color : '#ffcc33'
                })
              })
            })
          });

          map.addLayer(drawLayer);

  }

                var draw;
          function startDraw(type){
              if(draw != null){
                cancelDraw(); 
            }
            draw = new ol.interaction.Draw({
            source:drawLayer.getSource(),
            type:type
            });
            map.addInteraction(draw);
            
          }

          function cancelDraw(){
            if(draw == null)return;
            map.removeInteraction(draw);
          }

      function removeTopLayer(){
          var layers = map.getLayers();
          layers.pop();
      }

      function swapTopLayer(){
          var layers = map.getLayers();
          var topLayer = layers.removeAt(2);
          layers.insertAt(1, topLayer);
      }





    </script>
  </body>
</html>